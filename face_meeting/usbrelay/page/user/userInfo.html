<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>个人资料</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="../../lib/layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../../css/public.css" media="all" />
	<link rel="stylesheet" type="text/css" href="../../css/my.css" />
	<link rel="icon" href="../../images/ico/favicon.ico">
</head>

<body class="bg">
	<!-- 导航条 -->
	<div class="layui-header">
		<ul class="layui-nav layui-bg-green">
			<li class="layui-nav-item"><a class="" href="index.html"><i class="layui-icon layui-icon-home"></i> 会议室管理</a></li>
		</ul>
		<ul class="layui-nav layui-layout-right layui-bg-green">
			<!-- 会议预定 -->
			<li class="layui-nav-item">
				<a class="" href="javascript:;">预定会议</a>
				<dl class="layui-nav-child">
					<dd>
						<a href="meetAdd.html"><i class="layui-icon layui-icon-add-circle"></i> 发起会议</a>
					</dd>
					<dd>
						<a href="meetMy.html"><i class="layui-icon layui-icon-form"></i> 我的会议</a>
					</dd>
					<dd>
						<a href="meetGroup.html"><i class="layui-icon layui-icon-user"></i> 我的小组</a>
					</dd>
<!-- 					<dd>
						<a href="meetMessage.html"><i class="layui-icon layui-icon-notice"></i> 消息中心</a>
					</dd>

					<dd>
						<a href="meetFile.html"><i class="layui-icon layui-icon-file"></i> 会议文件</a>
					</dd> -->
				</dl>
			</li>

			<!-- 个人设置 -->
			<li class="layui-nav-item" id="userInfo">
				<a href="javascript:;">
					<img src="../../images/face.jpg" id="pIcon" class="layui-nav-img userAvatar" width="35" height="35">
					<cite class="username" id="pName">咚咚咚</cite>
				</a>
				<dl class="layui-nav-child">
					<dd>
						<a href="userInfo.html" class="">
							<i class="layui-icon layui-icon-tabs"></i><cite>个人资料</cite>
						</a>
					</dd>
					<dd>
						<a href="userChangepwd.html" class="">
							<i class="layui-icon layui-icon-edit"></i><cite>修改密码</cite>
						</a>
					</dd>
					<dd><a href="../user-login/login.html" class="signOut"><i class=" layui-icon layui-icon-close-fill"></i><cite>退出账号</cite></a></dd>
				</dl>
			</li>
		</ul>
	</div>

	<div class="layui-container">
		<div class="layui-row">
		<div class="layui-col-md8 layui-col-lg8 inner-box">
		<form class="layui-form layui-row" lay-filter="userInfo">
			<div class="layui-col-md4 layui-col-xs12 user_right">
				<div class="layui-upload-list">
					<img class="layui-upload-img layui-circle userFaceBtn userAvatar" id="userFace" src="../../images/default.jpg">
				</div>
				<button type="button" name="file" id="iconChange" class="layui-btn layui-btn-primary userFaceBtn"><i class="layui-icon">&#xe67c;</i>
					更换头像
				</button>
			</div>
			<div class="layui-col-md6 layui-col-xs12">
				<br>
				<div class="layui-form-item">
					<label class="layui-form-label">用户名</label>
					<div class="layui-input-block">
						<input type="text" name="pName" value="" id="userName" placeholder="请输入真实姓名" lay-verify="required" class="layui-input realName">
					</div>
				</div>
				<div class="layui-form-item" pane="">
					<label class="layui-form-label">性别</label>
					<div class="layui-input-block userSex">
						<input class="pGender1" type="radio" name="pGender" value="男" title="男" checked="">
						<input class="pGender2" type="radio" name="pGender" value="女" title="女">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">手机号码</label>
					<div class="layui-input-block">
						<input type="tel" name="pTel" value="" placeholder="请输入手机号码" lay-verify="phone" class="layui-input">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">部门</label>
					<div class="layui-input-block">
						<input type="text" name="pDept" disabled value="" class="layui-input layui-disabled">
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">职位</label>
					<div class="layui-input-block">
						<input type="text" name="pRole" disabled value="" class="layui-input layui-disabled">
					</div>
				</div>
				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn" lay-submit lay-filter="changeUser">保存修改</button>
						<button type="reset" class="layui-btn layui-btn-primary">清空输入</button>
					</div>
				</div>
			</div>
		</form>
		</div>
		</div>
	</div>
	<script type="text/javascript" src="../../lib/layui/layui.js"></script>
	<script src="../../js/jquery-1.11.1.js" type="text/javascript"></script>

	<script src="../../js/user/common.js" type="text/javascript"></script>
	<script src="../../js/user/headName.js" type="text/javascript"></script>

	<script>
		if (pIcon != "aWNvbg==" && pIcon != null && pIcon != 'null') {
			$('#userFace').attr('src', "data:image/jpeg;base64," + pIcon);
		}
		layui.use(['element', 'layer', 'jquery', 'upload', 'form'], function () {
			var element = layui.element;
			var layer = layui.layer;
			var $ = layui.$;
			var form = layui.form;
			var upload = layui.upload;

			// 获取用户信息
			var url = path + '/user/getPerson.do';
			$.ajax({
				url: url,
				type: "post",
				traditional: true, //这使json格式的字符不会被转码
				data: JSON.stringify({
					"pId": userId,
				}),
				contentType: 'application/json;charset=UTF-8', //这里的这行是关键
				dataType: "json",
				// dataType: "text",
				success: function (data) {
					// console.log(data);
					form.val("userInfo", {
						// "name": "value"
						"pName": data.data.pName,
						"pTel": data.data.pTel,
						"pDept": data.data.pDept,
						"pRole": data.data.pRole,
						"pGender": data.data.pGender,
					});
					form.render(); //更新全部  

				},
				error: function () {
					console.log("ajax请求失败");
				}
			});

			//图片上传
			// var url = path + "/user/update.do";
			var url = path + "/user/updatenew.do";
			// console.log("url是：" + url)
			// console.log("userId:" + userId)
			var uploadInst = upload.render({
				elem: '#iconChange', //绑定元素
				// url: path+'/user/changeImage.do', //上传接口
				url: url, //上传接口
				accept: 'images',
				method: 'post',
				size: 60,
				acceptMime: 'image/*', //只显示图片文件
				number: 1,
				data: {
					'pId': userId
				},
				before: function (obj) {
					/*如果您不想用上面的URL 进行上传,也可以在这里,添加你的上传方式*/
					obj.preview(function (index, file, result) {
						// console.log('base64')
						// console.log(result)
						$('#userFace').attr('src', result); //图片链接（base64）
					});
				},
				done: function (data, index, upload) {
					// 回调返回三个参数，分别为：服务端响应信息、当前文件的索引、重新上传的方法

					// console.log("传过来的是：")
					// console.log(data)
					// console.log("data.data是：" + JSON.stringify(data.data))
					localStorage.setItem("userId", data.data.pId);
					localStorage.setItem("userName", data.data.pName);
					localStorage.setItem("pIcon", data.data.pIcon);
					layer.msg('头像修改成功', {
						icon: 1,
						time: 1000
					});
					getNameAndIcon();
				},
				error: function () {
					//请求异常回调
					layer.msg("图片修改失败")
				}
			});

			//表单提交，修改个人信息
			form.on("submit(changeUser)", function (data) {
				console.log(data.field);
				var url = path + "/user/userInfoUpdate.do";
				$.ajax({
					url: url,
					type: "post",
					traditional: true, //这使json格式的字符不会被转码
					data: JSON.stringify({
						'pId': userId,
						'pName': data.field.pName,
						'pGender': data.field.pGender,
						'pTel': data.field.pTel,
					}),
					contentType: 'application/json;charset=UTF-8', //这里的这行是关键
					dataType: "json",
					// dataType: "text",
					success: function (data) {
						// console.log(data)
						if (data.status == 0) {
							layer.msg('更新用户信息成功', {
								icon: 1,
								time: 1000
							});
						}
					},
					error: function () {
						console.log("ajax请求失败");
					}
				});
				return false;
			})

		});
	</script>
</body>

</html>